# Основы системы PlayСhain

Данный функционал подсистемы PlayChain предназначен:

Для ведения учета средств игроков и выплат владельцам комнат. 
Борьбы с мошенничеством как со стороны игроков, так и со стороны владельцев комнат
Возврата средств игроков в случае мошенничества или сбоев игровых серверов

Основные объекты бизнес-логики:

* Комната
* Игровой стол
* Владелец стола
* Наблюдатель
* Игрок

Основная функция блокчейн - это учет движения цифровых денежных средств (далее просто “средств”) пользователей. В контексте описываемого функционала будут рассматриваться следующие виды движения средств:

Игрок предоставляет средства игровому столу.
Игрок возвращает средства
Система возвращает средства игроку
Изменяются средства игрока на игровом столе по результатам игрового процесса
Владелец стола получает часть средств по результатам игрового процесса 

Для проведения игр (как правило, с целью получения дохода) пользователь блокчейн создает объект “комната” и становится её владельцем. В комнате владелец создаёт столы с заданными характеристиками (в блокчейне характеристики стола это только строка с метаинформацией в распределенной БД). Владелец комнаты является “владельцем стола”, который он создал в своей комнате.

В playchain владелец комнаты является также “наблюдателем” для столов в чужих комнатах. Наблюдатели мотивируются получением части средств по результатам игрового процесса, но этот вид движения средств здесь не рассматривается (СМ документацию по реферальной системе)

Участвовать в играх может специальный пользователь блокчейн: “игрок”. Пользователя становится игроком автоматически при его создании через приглашение подсистемы PlayChain. Владелец стола так же может сделать игрока из обычного пользователя блокчейн (если он уже создан средствами блокчейн)

Для проведения игры владельцу стола необходимо собрать игроков. Операция сбора проводится в два этапа (процедура A на Рис. 2).
 
На первом этапе игрок передаёт часть своих средств (на которые он хочет играть) в PlayChain указав версию протокола и информацию об игре в которой он хочет участвовать. 
Для TotalPoker в качестве информации об игре используется стоимость BigBlind и константы для пересчёта PLC в Chips. Данная специфическая TotalPoker информация
передается в PlayChain одной строкой (как метаинформация)
Далее PlayChain при формировании очередного блока осуществляет поиск стола 
с соответствующей метаинформацией и версией протокола.
При поиске могут использоваться разные дополнительные критерии учитывающие загруженность стола и состав участников. Алгоритм поиска описывается отдельно.

Игрок (а точнее клиентское приложение) ожидает завершения алгоритма поиска по алгоритму указанному на Рис. 1

[[]]

Рис. 1 Алгоритм ожидания поиска стола

В случае успешного завершения поиска игроку возвращается идентификатор стола  и адрес игрового сервера его обслуживающего. В случае неудачи средства возвращаются игроку по истечении времени PBL (Рис. 1)

На втором этапе игрок устанавливает соединение с игровым сервером и сообщает свое желание “сесть” за игровой стол операцией Buy-In с указанием идентификатора заявки из первого этапа (СМ Рис. 2). 

У игрового сервера обслуживающего стол установлена обратная связь с PlayChain для своих столов и он узнаёт о том, что система выбрала его стол для игрока (callback на
Рис. 2).

[[]]

Рис. 2 Диаграмма взаимодействия в концепции протокола движения средств

- процедура посадки игрока за стол
- процедура возвращения игрока за стол при потери соединения с игровым сервером
- процедура докупки в процессе игры
- процедура выхода игрока из игры

Если Buy-In принимается игровым сервером он подписывает соответствующую транзакцию ключом владельца стола и завершает процедуру посадки игрока за  стол (A).

Если процедура A была прервана, например игровой сервер недоступен или не захотел принять Buy-In (по игровой логике или нехватке ресурсов) до истечения периода PBL, средства возвращаются игроку системой PlayChain.

Игровой сервер анализирует состав игроков на своих столах и принимает решение о запуске игры. В PlayChain существует таймер на ожидание игры (TWS) по истечении которого средства возвращаются игроку и для посадки за стол нужно будет повторить процедуру A. Поэтому игровому серверу нужно успеть запустить игру (ведь игрок изъявил желание играть инициировав процедуру A) до завершения TWS. 

Для запуска игры сервер инициирует процедуру голосования. Уведомляет игроков (за столом, которых он посчитал нужным включить в игру) о запуске игры.

Получив уведомление от игрового сервера каждый игрок от своего имени, а также сам игровой сервер от имени владельца стола, отправляют в PlayChain голос за начало игры исходя из своей игровой модели.

Голос за начало игры представляет собой следующие данные, подписанные ключом участника голосования: 

Список сумм (PLC) по каждому участнику игры (обычно* соответствует переданной каждым игроком в процедуре A с учётом результата  игр)
Метаинформация игры (для техасского холдема это может быть информация о том, кто является диллером)

* Голосование может проводиться за участие в игре меньшего количества игроков чем количество тех, кто передал средства. А также с меньшим количеством средств. Однако неиспользованные средства будут возвращены игрокам в соответствии с TWS.
Недопустимость передачи большей суммы чем была снята в процедуре A контролируется PlayChain.

Процедура голосования призвана обеспечить честность на начальном и заключительном (будет рассмотрен далее) этапах игры т.е. устранить возможность фальсификации игровой модели как  со стороны игрока так и со стороны владельца стола.

PlayChain ожидает голоса участников в течении небольшого временного интервала TWVGS или до его окончания (если все голоса собраны). 
Ожидаются голоса от всех заявленных участников игры по версии владельца стола.
PlayChain также принимает голоса от наблюдателей, которые могут компенсировать нехватку голосов от других участников игры (кроме владельца стола). Коэффициент компенсации (сколько голосов в процентном соотношении может быть замещено) задаётся в настройках PlayChain.

Голосование считается успешным, если до истечения TWVGS собрано необходимое количество голосов и выполнилось условие:

P*(m-1)/N <= P - R                                (1)

P - 100 %
m - количество различных вариантов голосов
N - количество голосов
R - константа (60 % по умолчанию)

Для состоявшегося голосования выбирается голос, который прислало максимальное количество участников. В соответствии с данными этого голоса производятся движения средств в PLC. Для голосования за начало игры они помечаются как средства в игре и на них перестаёт действовать таймаут TWS.

При сравнение голосов playchain не анализирует их содержимое, а считает RIPEMD-160
от данных голоса. Полученный хэш для одинаковых голосов должен совпадать. Исключением является команда сброса результата, когда список вводимых в игру средств или результатов пуст. Т.е. playchain проверяет факт того, что список пуст.

Стол переходит и состояния “Voting for Playing” в новое состояние “Playing” (СМ Рис. 3).

Для статуса Playing действует новый таймаут TWG по истечении которого стол будет возвращен в состояние “Free”, а все средства на столе возвращены игрокам. 
Так как переход по TWG считается системой PlayChain аварийным поведением игрового сервера.

Поэтому до истечения TWG игровой сервер должен подводить итоги игры. В случае покера для этого подходят завершения раздач (showdown).

[[]]

Рис. 3 Состояния стола и переходы между состояниями посредством выполнения операции голосования (V на схеме)
Pending означает что голос принимается PlayChain, переключения статуса не производит и будет учтен только после переключении статуса и определении наличия перехода voting completed. 

Для подведения итога проводится голосование за результат игры.

После подведения итога игру нужно будет запускать снова. В зависимости от типа игры 
эта процедура может быть скрыта от игрока или соответствовать игровой логике как в случае покера.

Голос за результат игры представляет собой следующие данные, подписанные ключом участника голосования:

Список сумм (PLC) по каждому участнику игры на текущий момент с указанием отчислений владельцу стола (если таковые предусмотрены логикой игры). Здесь учитывается выигрыш и проигрыш игроков если таковые случились с момента последнего голосования.
Метаинформация игры (лог игры с момента последней процедуры голосования за начало)

Голоса собираются в течении небольшого таймаута TWVGR, но может завершиться раньше если собрано необходимое количество голосов.
Голосование не может проводиться для меньшего количества голосов* чем количество тех, кто принимал участие в игре. 
Но как и в случае с голосованием за начало игры, голоса участников игры могут замещаться наблюдателями, если это разрешено настройками PlayChain.
Кроме-того, на этом этапе требуются голоса от наблюдателей принявших участие в голосовании за начало игры.

* Настройками PlayChain предусмотрена потеря некоторого количества голосов по истечении таймаута TWVGR. Т.е. если сработал таймаут и не хватает некоторого указанного количества голосов игроков (не наблюдателей!) считается что голоса собраны и производится расчет кворума.

Для состоявшегося голосования также выбирается голос с максимальным количеством проголосовавших. В соответствии с данными этого голоса производятся движения средств в PLC. Средства на столе приводятся в соответствии с данными выбранного голоса и на них начинает действовать таймаут TWS.
Стол переходит и состояния “Voting for Result” в новое состояние “Free” (СМ Рис. 3)

Таким образом игрок начав с процедуры A периодически участвует в голосовании 
при переходах между статусами Free -> Playing -> Free пока у него сохраняется положительный баланс на столе или он не выполнил процедуру D.

При выполнении buy-out игроком, если он касается средств в игре процедура вывода выполнится PlayChain  только после выполнения ближайшего голосования за результат. Т.е. будет ожидать подтверждения правильности заявленной на вывод суммы посредством голосования за результат. 


Описание операций PlayChain

Список операций отправляемых в транзакциях участниками протокола (описанного выше)


| | |
|---|---|
| buy_in_reserve_operation | Размещение заявки на игру (Рис. 2) |
| buy_in_reserving_cancel_operation | Отмена заявки на игру (по идентификатору) |
| buy_in_reserving_cancel_all_operation | Отмена всех заявок игрока |
| buy_in_reserving_resolve_operation | Принятие заявки владельцем стола (Рис. 2) |
| buy_in_table_operation | Перевод средств на определенный стол |
| buy_out_table_operation | Размещение заявки на вывод средств |
| game_start_playing_check_operation | Голосование за начало игры |
| game_result_check_operation | Голосование за результат игры |
| game_reset_operation | Сброс игры (сопровождается возвратом средств на момент выполнения операции). Выполняется только от имени владельца стола |

Полный список виртуальных операций:

| | |
|---|---|
| buy_in_reserving_allocated_table_operation | Успешной заверешние операции find_table по конкретной заявке |
| buy_in_reserving_expire_operation | Отмена заявки по таймеру PBL |
| buy_in_expire_operation | Возврат средств по таймеру TWS |

Подмножество game_event_operation:

| | |
|---|---|
| game_start_playing_validated | Успешный переход игрового стола в состояние Playing |
| game_result_validated | Успешный переход игрового стола в состояние Table Free |
| game_rollback | Игра отменена. Средства восстановлены на состояние начала игры |
| fail_consensus_game_start_playing | |
| fail_consensus_game_result | |
| fail_expire_game_start_playing | |
| fail_expire_game_result | |
| fail_expire_game_lifetime | |
| fraud_game_start_playing_check | |
| fraud_game_result_check | |
| buy_out_allowed | Рассмотрен и выполнен  возврат средств заблокированных на время игры (отложенный Buy-Out) на баланс игрока |
| buy_in_return | Возврат средств со стола на баланс игрока |
| game_cash_return | Возврат средств из игры на стол |
| fraud_buy_out | |
| fail_vote | Отмена попытки голосования отдельного участника |

Следующие события фиксируются playchain как мошенничество или нестабильная работа игрового сервиса в виде специальных виртуальных операций и может быть 
использовано для квалификационного ранжирования игроков и владельцев столов:

 * несовпадение результатов голосования Voting For Playing более допустимого процента (нарушение консенсуса)
Подтип fail_consensus_game_start_playing операции game_event_operation

*  завершение процедуры голосования по таймеру TWVGS
Подтип fail_expire_game_start_playing операции game_event_operation

*  несовпадение результатов голосования Voting For Result более допустимого процента (нарушение консенсуса)
Подтип fail_consensus_game_result операции game_event_operation

*  завершение процедуры голосования по таймеру TWVGR
Подтип fail_expire_game_result операции game_event_operation

*  срабатывание TWG таймера
Подтип fail_expire_game_lifetime операции game_event_operation

*  голос участника голосования не совпадает с голосом большинства при наличии консенсуса для Voting For Playing
Подтип fraud_game_start_playing_check операции game_event_operation

*  голос участника голосования не совпадает с голосом большинства при наличии консенсуса для Voting For Result 
Подтип fraud_game_result_check операции game_event_operation

*  в состоянии Playing игрок запросил сумму превышающую его средства на момент окончания игры 
Подтип fraud_buy_out операции game_event_operation


Пример нарушения консенсуса для порога 60 %:  для N = 3 все три голоса различны.
Для 2 одинаковых из 3 консенсус достигается (⅔ = 66.(6) %), для отличающегося голоса будет записано fraud_game_start_playing_check_operation или fraud_game_result_check_operation.  Средства на столе будут синхронизированы, а ожидающие Buy-out рассмотрены по результату большинства.
